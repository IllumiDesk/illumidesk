ARG BASE_IMAGE={{docker_illumidesk_notebook_base_image}}
FROM $BASE_IMAGE AS base

FROM {{docker_rstudio_base_image}}

ARG NB_GID=100
ENV NB_GID=$NB_GID

USER root

RUN mkdir -p /etc/jupyter

# copy files from base image
COPY --from=base /usr/local/bin/start* /usr/local/bin/
COPY --from=base /usr/local/bin/fix-permissions /usr/local/bin/
COPY --from=base /etc/jupyter/jupyter_notebook_config.py /etc/jupyter/
COPY --from=base /usr/local/bin/fix-permissions /usr/local/bin/

# update permissions
RUN chmod a+rx /usr/local/bin/fix-permissions
RUN chmod +rx /usr/local/bin/start*
RUN chmod +rx /etc/jupyter/jupyter_notebook_config.py

# copy rstudio configuration
COPY rserver.conf /etc/rstudio/rserver.conf

# Fix permissions on /etc/jupyter and /etc/rstudio as root
RUN fix-permissions /etc/jupyter/ \
 && fix-permissions /etc/rstudio/ \
 && fix-permissions $CONDA_DIR \
 && fix-permissions /home/$NB_USER

USER $NB_USER
